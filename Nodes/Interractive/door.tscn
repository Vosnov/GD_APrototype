[gd_scene load_steps=14 format=3 uid="uid://b3vkk1qyqod6g"]

[ext_resource type="AudioStream" uid="uid://cdujunlftjd2c" path="res://SFX/Interractive/Door/CloseDoor2.mp3" id="1_tvk3s"]
[ext_resource type="Material" uid="uid://d0p81ue363vha" path="res://Materials/test_mat_2.tres" id="1_wd37w"]
[ext_resource type="AudioStream" uid="uid://damk3nqqkpmq0" path="res://SFX/Interractive/Door/OpenDoor3.mp3" id="2_lpv0w"]
[ext_resource type="Script" path="res://Scripts/Helpers/door_active_node.gd" id="2_s6rgp"]
[ext_resource type="PackedScene" uid="uid://rhxly5n72acf" path="res://Nodes/ActiveSprites/door_accept_sprite.tscn" id="3_0fx7q"]
[ext_resource type="AudioStream" uid="uid://b4tlt6oxose46" path="res://SFX/Interractive/Door/BrokenDoor1.mp3" id="3_igjkq"]
[ext_resource type="PackedScene" uid="uid://ds5hlv1fie0sv" path="res://Nodes/ActiveSprites/door_need_accept_sprite.tscn" id="3_pj662"]
[ext_resource type="PackedScene" uid="uid://dxkrx5vqri5e4" path="res://Nodes/ActiveSprites/door_close_sprite.tscn" id="4_201g0"]
[ext_resource type="AudioStream" uid="uid://wfeygk2txhqp" path="res://SFX/Interractive/Door/KeyOpenDoor.mp3" id="4_u2ohf"]

[sub_resource type="GDScript" id="GDScript_8bmqr"]
script/source = "extends Node3D

@export var ACCEPT_STATE = DoorActiveNode.AcceptState.ACCEPT
@export_file(\"*.tscn\") var NEXT_SCENE
@export var NEED_KEY_DATA: ItemData
@export_multiline var CLOSE_MESSAGE: String
@export_multiline var NEED_ACCEPT_MESSAGE: String
@export_multiline var OPENED_MESSAGE: String

@export var CLOSING_AUDIO: AudioStream
@export var OPEN_AUDIO: AudioStream
@export var BROKEN_AUDIO: AudioStream
@export var KEY_OPEN_DOOR: AudioStream

@onready var active_node = $DoorActiveNode as DoorActiveNode
@onready var spawn_point = $SpawnPoint
@onready var audio_stream_player_3d = $AudioStreamPlayer3D

var is_accepted = false
var door_opened_message = \"\"

func _ready():
	if GlobalVariables.door_prev_scene == NEXT_SCENE:
		audio_stream_player_3d.stream = CLOSING_AUDIO
		audio_stream_player_3d.play()
	
	if NEED_KEY_DATA:
		door_opened_message = tr(OPENED_MESSAGE) % [NEED_KEY_DATA.NAME]
	active_node.ACCEPT_STATE = ACCEPT_STATE

func has_key():
	var items = Inventory.SLOTS.map(func(slot: SlotData): return slot.ITEM_DATA)
	return items.has(NEED_KEY_DATA)

func _on_door_active_node_action_pressed():
	if ACCEPT_STATE == DoorActiveNode.AcceptState.CLOSE:
		play_audio(BROKEN_AUDIO)
		
		Events.emit_signal('message_ui', CLOSE_MESSAGE)
		return
		
	if ACCEPT_STATE == DoorActiveNode.AcceptState.NEED_ACCEPT and !is_accepted:
		if has_key():
			play_audio(KEY_OPEN_DOOR)
			
			active_node.change_sprite(DoorActiveNode.AcceptState.ACCEPT)
			Events.emit_signal('inventory_remove_item', NEED_KEY_DATA)
			Events.emit_signal('message_ui', door_opened_message)
			is_accepted = true
			return
		else:
			play_audio(BROKEN_AUDIO)
			
			Events.emit_signal('message_ui', NEED_ACCEPT_MESSAGE)
			return
	
	play_audio(OPEN_AUDIO)
	GlobalVariables.player_spawn_data[owner.scene_file_path] = spawn_point.global_transform
	GlobalVariables.door_prev_scene = owner.scene_file_path
	SceneTransition.change_scene(NEXT_SCENE)

func play_audio(stream: AudioStream):
	if audio_stream_player_3d.playing: return
	audio_stream_player_3d.stream = stream
	audio_stream_player_3d.play()
"

[sub_resource type="BoxMesh" id="BoxMesh_jb30f"]
size = Vector3(1, 2, 1)

[sub_resource type="BoxShape3D" id="BoxShape3D_5p4sj"]
size = Vector3(1, 2, 1)

[sub_resource type="BoxShape3D" id="BoxShape3D_vk8t2"]
size = Vector3(1, 2, 1)

[node name="Door" type="StaticBody3D"]
script = SubResource("GDScript_8bmqr")
CLOSE_MESSAGE = "door.close"
NEED_ACCEPT_MESSAGE = "door.needKey"
OPENED_MESSAGE = "door.openBy"
CLOSING_AUDIO = ExtResource("1_tvk3s")
OPEN_AUDIO = ExtResource("2_lpv0w")
BROKEN_AUDIO = ExtResource("3_igjkq")
KEY_OPEN_DOOR = ExtResource("4_u2ohf")

[node name="MeshInstance3D" type="MeshInstance3D" parent="."]
material_override = ExtResource("1_wd37w")
mesh = SubResource("BoxMesh_jb30f")

[node name="Area3D" type="Area3D" parent="."]
collision_layer = 2
collision_mask = 2

[node name="CollisionShape3D" type="CollisionShape3D" parent="Area3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -0.26225)
shape = SubResource("BoxShape3D_5p4sj")

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
shape = SubResource("BoxShape3D_vk8t2")

[node name="SpawnPoint" type="Marker3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -1, -1)

[node name="DoorActiveNode" type="Node3D" parent="." node_paths=PackedStringArray("AREA")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.492469, -0.627733)
script = ExtResource("2_s6rgp")
ACCEPT_SPRITE = ExtResource("3_0fx7q")
NEED_ACCEPT_SPRITE = ExtResource("3_pj662")
CLOSE_SPRITE = ExtResource("4_201g0")
AREA = NodePath("../Area3D")

[node name="AudioStreamPlayer3D" type="AudioStreamPlayer3D" parent="."]
max_distance = 3.0
bus = &"FX"

[connection signal="action_pressed" from="DoorActiveNode" to="." method="_on_door_active_node_action_pressed"]
